<%
  const role = user && user.role ? user.role.toLowerCase().trim() : '';
  const CAN_ADD = role === 'admin' || role === 'clerk';
  const CAN_DELETE = role === 'admin';
%>

<%- include('layout', {
  title: 'Cases',
  user,
  body: `
<h2 style="text-align:center;">Cases</h2>

${CAN_ADD ? `
  <div style="text-align:center; margin-bottom:15px;">
    <button class="btn" id="add-case-btn">Add Case</button>
  </div>
` : ''}

<table class="table" id="cases-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


<div id="case-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modal-title"></h3>

    <input type="text" id="case-title" placeholder="Title" />
    <textarea id="case-description" placeholder="Description"></textarea>
    <input type="text" id="case-status" placeholder="Status (Pending/In Progress/Closed)" />

    <div id="evidence-list"></div>

    <button id="save-case" class="btn">Save</button>
  </div>
</div>


<div id="confirm-modal" class="modal">
  <div class="modal-content">
    <p>Are you sure you want to delete this case?</p>
    <button id="confirm-delete" class="btn delete">Delete</button>
    <button id="cancel-delete" class="btn">Cancel</button>
  </div>
</div>

<style>
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; }
.modal-content { background:black; margin:10% auto; padding:20px; border-radius:10px; width:420px; text-align:center; }
.modal-content input, .modal-content textarea { width:90%; margin:8px 0; padding:8px; }
.close { float:right; font-size:1.5rem; cursor:pointer; }
#evidence-list { text-align:left; margin-top:10px; color:white; }
</style>

<script>
const CAN_DELETE = ${CAN_DELETE};
let deleteCaseId = null;

//THIS IS TO LOAD CASES
async function fetchCases() {
  const res = await fetch('/api/cases', { credentials: 'include' });
  if (!res.ok) return alert('Failed to fetch cases');
  const cases = await res.json();

  const tbody = document.querySelector('#cases-table tbody');
  tbody.innerHTML = '';

  cases.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = \`
      <td>\${c.id}</td>
      <td>\${c.title}</td>
      <td>\${c.status}</td>
      <td>
        <button class="btn" onclick="openViewModal(\${c.id})">View</button>
        \${CAN_DELETE ? '<button class="btn delete" onclick="openDeleteModal(' + c.id + ')">Delete</button>' : ''}
      </td>
    \`;
    tbody.appendChild(tr);
  });
}


const caseModal = document.getElementById('case-modal');
const confirmModal = document.getElementById('confirm-modal');
const modalTitle = document.getElementById('modal-title');
const titleInput = document.getElementById('case-title');
const descInput = document.getElementById('case-description');
const statusInput = document.getElementById('case-status');
const evidenceList = document.getElementById('evidence-list');
const saveBtn = document.getElementById('save-case');

document.querySelector('.close').onclick = () => caseModal.style.display = 'none';
document.getElementById('add-case-btn')?.addEventListener('click', openAddModal);


function openAddModal() {
  modalTitle.textContent = 'Add Case';
  titleInput.value = '';
  descInput.value = '';
  statusInput.value = 'Pending';
  titleInput.disabled = false;
  descInput.disabled = false;
  statusInput.disabled = false;
  evidenceList.innerHTML = '';
  saveBtn.style.display = 'inline-block';
  caseModal.style.display = 'block';
}

saveBtn.onclick = async () => {
  if (!titleInput.value || !descInput.value) {
    alert('Enter title and description');
    return;
  }

  const res = await fetch('/api/cases', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: titleInput.value,
      description: descInput.value,
      status: statusInput.value || 'Pending'
    })
  });

  if (!res.ok) return alert('Failed to add case');

  caseModal.style.display = 'none';
  fetchCases();
};


async function openViewModal(id) {
  modalTitle.textContent = 'View Case';
  titleInput.disabled = true;
  descInput.disabled = true;
  statusInput.disabled = true;
  saveBtn.style.display = 'none';
  evidenceList.innerHTML = '';
  caseModal.style.display = 'block';

  const caseRes = await fetch('/api/cases/' + id, { credentials: 'include' });
  if (!caseRes.ok) return alert('Failed to fetch case');
  const c = await caseRes.json();

  titleInput.value = c.title;
  descInput.value = c.description;
  statusInput.value = c.status;

  const evRes = await fetch('/api/evidence/case/' + id, { credentials: 'include' });
  if (!evRes.ok) return evidenceList.innerHTML = '<strong>No Evidence</strong>';
  const evidence = await evRes.json();

  if (evidence.length) {
    let ul = '<ul>';
    evidence.forEach(e => ul += '<li>' + (e.file_path || e.type) + '</li>');
    ul += '</ul>';
    evidenceList.innerHTML = '<strong>Evidence:</strong>' + ul;
  } else {
    evidenceList.innerHTML = '<strong>No Evidence</strong>';
  }
}


function openDeleteModal(id) {
  deleteCaseId = id;
  confirmModal.style.display = 'block';
}

document.getElementById('cancel-delete').onclick = () => {
  confirmModal.style.display = 'none';
  deleteCaseId = null;
};

document.getElementById('confirm-delete').onclick = async () => {
  const res = await fetch('/api/cases/' + deleteCaseId, {
    method: 'DELETE',
    credentials: 'include'
  });

  if (!res.ok) return alert('Failed to delete case');

  confirmModal.style.display = 'none';
  deleteCaseId = null;
  fetchCases();
};

fetchCases();
</script>
`
}) %>
